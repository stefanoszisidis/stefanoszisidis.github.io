<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Music - RunTheCode.gr</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <style>
    /* Additional styles for playlist selection */
    .year-selector {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
    }

    .year-btn {
      padding: 0.75rem 1.5rem;
      background-color: rgba(56, 189, 248, 0.1);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s ease;
      font-weight: 500;
    }

    .year-btn:hover {
      background-color: rgba(56, 189, 248, 0.2);
      border-color: var(--accent-primary);
    }

    .year-btn.active {
      background-color: var(--accent-primary);
      border-color: var(--accent-primary);
      color: var(--bg-body);
    }

    .quarter-selector {
      display: none;
      gap: 0.75rem;
      margin-top: 1rem;
      flex-wrap: wrap;
    }

    .quarter-selector.visible {
      display: flex;
    }

    .quarter-btn {
      padding: 0.5rem 1rem;
      background-color: var(--bg-body);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 0.9rem;
    }

    .quarter-btn:hover {
      background-color: rgba(56, 189, 248, 0.1);
      border-color: var(--accent-primary);
      color: var(--text-primary);
    }

    .quarter-btn.active {
      background-color: rgba(56, 189, 248, 0.15);
      border-color: var(--accent-primary);
      color: var(--accent-primary);
      font-weight: 600;
    }

    .selection-status {
      margin-top: 1.5rem;
      display: none;
    }

    .selection-status.visible {
      display: block;
    }

    .music-content {
      display: none;
    }

    .music-content.visible {
      display: block;
    }

    /* Flex container for playlist cards */
    .playlist-info .container {
      display: flex;
      gap: 2rem;
      flex-wrap: wrap;
    }

    .info-card {
      flex: 1;
      min-width: 300px;
    }

    /* Genre specific styles */
    .genre-selector {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
    }

    .genre-btn {
      padding: 0.75rem 1.5rem;
      background-color: rgba(16, 185, 129, 0.1);
      /* Green tint for genre */
      border: 1px solid var(--border-color);
      border-radius: 6px;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s ease;
      font-weight: 500;
    }

    .genre-btn:hover {
      background-color: rgba(16, 185, 129, 0.2);
      border-color: #10b981;
    }

    .genre-btn.active {
      background-color: #10b981;
      border-color: #10b981;
      color: var(--bg-body);
    }
  </style>
</head>

<body>
  <header class="site-header">
    <div class="container">
      <a href="index.html" class="site-title">RunTheCode.gr</a>
      <nav class="breadcrumb">
        <a href="index.html">Home</a>
        <span class="separator">/</span>
        <span class="current">Music</span>
      </nav>
    </div>
  </header>

  <main>
    <section class="music-hero">
      <div class="container">
        <h1>Music</h1>
        <p class="music-subtitle">Curated quarterly playlists featuring handpicked tracks</p>
      </div>
    </section>

    <section class="playlist-info">
      <div class="container">
        <!-- Card 1: Quarterly Collections -->
        <div class="info-card">
          <h2>Quarterly Music Collections</h2>
          <p>Every three months, I curate a special playlist of songs that resonated with me during that period.
            Each collection represents a musical journey through the quarter.</p>

          <p style="margin-top: 1.5rem; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-primary);">Select a
            year:</p>

          <!-- Year Selection -->
          <div class="year-selector">
            <button class="year-btn" data-year="2025">2025</button>
            <button class="year-btn" data-year="2024">2024</button>
            <button class="year-btn" data-year="2023">2023</button>
          </div>

          <!-- Quarter Selection (dynamically populated) -->
          <div id="quarter-selector" class="quarter-selector"></div>

          <p id="selection-status" class="current-playlist selection-status">
            Currently selected: <strong><span id="selected-playlist"></span></strong>
          </p>
        </div>

        <!-- Card 2: Genre Based Playlists -->
        <div class="info-card">
          <h2>Genre Based Playlists</h2>
          <p>Exploring specific sounds and vibes. These collections focus on deep dives into specific genres, bringing
            together tracks that define a mood.</p>

          <p style="margin-top: 1.5rem; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-primary);">Select a
            genre:</p>

          <!-- Genre Selection -->
          <div id="genre-selector" class="genre-selector">
            <!-- Dynamically populated -->
          </div>

          <!-- Genre Year Selection (dynamically populated) -->
          <div id="genre-year-selector" class="quarter-selector"></div>

          <p id="genre-selection-status" class="current-playlist selection-status">
            Currently selected: <strong><span id="selected-genre-playlist"></span></strong>
          </p>
        </div>
      </div>
    </section>

    <section id="music-content" class="music-content">
      <div class="container">
        <div class="playlist-grid">
          <div class="video-container">
            <div class="video-wrapper">
              <div id="youtube-player"></div>
            </div>
          </div>

          <div class="tracklist-container">
            <h3>Tracklist</h3>
            <div id="tracklist" class="tracklist">
              <!-- Tracks will be dynamically loaded -->
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer class="site-footer">
    <div class="container">
      <p>&copy; 2025 RunTheCode.gr Team</p>
    </div>
  </footer>

  <script>
    // Playlist data structure (populated from JSON)
    let playlists = {};
    let genrePlaylists = {};

    // Player state variables
    let player;
    let isAPIReady = false;
    let playerInitialized = false;
    let updateInterval;
    let currentYear;
    let currentQuarter;
    let lastPlayingIndex = -1;

    // Load YouTube IFrame API
    const tag = document.createElement('script');
    tag.src = 'https://www.youtube.com/iframe_api';
    const firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

    // Called when API is ready (global callback required by YouTube API)
    function onYouTubeIframeAPIReady() {
      isAPIReady = true;
      console.log('YouTube API ready');
    }

    // Fallback data (mirrors playlists.json)
    const fallbackData = {
      "quarterly": {
        "2025": {
          "Q1": {
            "id": "PLo5Dkz0iHmDiF3jVCDKGcTFZj4kB6SU40",
            "name": "2025 Q1 Playlist",
            "tracks": [
              "Manchester Orchestra - The Gold (Phoebe Bridgers Version)",
              "Billie Eilish - CHIHIRO (Black Coffee Remix)",
              "Glass Beams - One Raga to a Disco Beat (A cover of 'Raga Bhairav' by Charanjit Singh)",
              "Gut Health - Inner Norm (Official Video)",
              "Sunday Morning",
              "Chumbawamba - The day the nazi died",
              "Kerala Dust - Bell (Official Video)",
              "Jack White - That's How I'm Feeling (Official Video)",
              "Protoje - BIG 45 (Official Video)",
              "Fontaines D.C. - Bug (Official Video)",
              "Emmanuel Jal X Bun Xapa - Chaak (Official Music Video)"
            ]
          },
          "Q2": {
            "id": "PLo5Dkz0iHmDg2t-p_Svq03PmNCNt75YcT",
            "name": "2025 Q2 Playlist",
            "tracks": [
              "GAMMAGAMMA - Avrio Vrady (Official Music Video)"
            ]
          },
          "Q3": {
            "id": "PLo5Dkz0iHmDjyhVfhAOGAzSgviW63XW2Y",
            "name": "2025 Q3 Playlist",
            "tracks": [
              "Κοινοί Θνητοί | Γινόμενο (Official Music Video)",
              "NUMA CREW - BASS HATER FEAT. DUB FX",
              "Beatie Wolfe, Brian Eno - Suddenly (Official Music Video)",
              "Ben l'Oncle Soul - THE WALLS (Visualizer)",
              "Björk - Crystalline (Omar Souleyman Remix)",
              "Dizzy Gillespie feat. Charlie Parker - A Night In Tunisia",
              "Doo Wop (That Thing) - Quantic & Anita Tijoux",
              "Earl Sixteen - Malcolm X",
              "Gizmo Varillas - Into the Night (Official Video)",
              "Kamakaze - BACKWIDDA",
              "Phil’s First Tear",
              "LCD Soundsystem - I Can Change",
              "Little Simz - Lion feat. Obongjayar (Official Audio)",
              "Parra for Cuva ft. Anna Naklab - Wicked Games (Official Music Video)",
              "Take Me Back",
              "Seba Campos - Los Halcones Remix (feat. Santiago Moraes) (Official Audio)",
              "shame - Quiet Life (Official Video)",
              "The Lijadu Sisters - Life Is Gone Down Low",
              "Them & Van Morrison- Baby Please Don't Go",
              "Valerie June - \"Astral Plane\"",
              "Numa Crew - Babylon feat. Riko Dan (Official Video)",
              "Ghost Orchid",
              "Kasabian - Hippie Sunshine (Official Visualiser)",
              "Ezra Collective - No One's Watching Me (feat. Olivia Dean) [Official Visualiser]",
              "Little Simz - Don't Leave Too Soon (Official Video) - Theme from Steve"
            ]
          },
          "Q4": {
            "id": "PLo5Dkz0iHmDjxYJplcWC5NUBPS1XIddVT",
            "name": "2025 Q4 Playlist",
            "tracks": [
              "I Against I",
              "Yehoud I - Leave Babylon",
              "Northwest Passage"
            ]
          }
        },
        "2024": {
          "Q1": {
            "id": "PLo5Dkz0iHmDjd3z4Dq_LcLBVkvhBru2wJ",
            "name": "2024 Q1 Playlist",
            "tracks": [
              "Funky Destination - The Inside Man (Soopasoul Remix)",
              "America - A Horse With No Name (Official Audio)",
              "John Lee Hooker & Canned Heat - Whiskey & Wimmen' [HQ]",
              "ΜΑΥΡΑ ΜΟΥ ΧΕΛΙΔΟΝΙΑ - ΚΩΣΤΑΝΤΗΣ ΠΙΣΤΙΟΛΗΣ",
              "Danger Mouse & Black Thought - Because feat. Joey Bada$$, Russ, and Dylan Cartlidge (Official Video)",
              "Prince Fatty - Expansions ft. Shniece McMenamin",
              "Savages Y Suefo - Our World Our Style",
              "King Stingray and Colin Hay close the 2023 APRA Music Awards with 'Down Under'.",
              "Beth Gibbons - Floating On A Moment (Official Video)",
              "Global Communication — 76 14 (1994/Full album) • Ambient",
              "Mdou Moctar- \"Funeral for Justice\" (Official Music Video)",
              "Glass Beams - 'Mahal' (Live)",
              "Nomik | Πες μου αν ήταν όλα ψέματα | Live (Σταυρός του Νότου) - 4K Video",
              "Nomik | Αφήστε με στη θάλασσα (Official Video)",
              "Empty Frame - Come Undone [Official Lyric Video - 2024]",
              "Grigoryan Brothers \"Deep Time\" (Official Music Video) with National Museum of Australia"
            ]
          },
          "Q2": {
            "id": "PLo5Dkz0iHmDh7BYPrDeKklquViYQg5G02",
            "name": "2024 Q2 Playlist",
            "tracks": [
              "Fontaines D.C. - Starburster (Official Video)",
              "Παύλος Παυλίδης - ΜΠΡΑΝΚΑΛΕΟΝΕ (Official Music Video)",
              "Parra for Cuva - Mimose (Official Visuals)",
              "Looking Good - The Witchy Djypsies",
              "Sigmataf - Μη συνηθίσεις το λίγο",
              "Full Flower Moon Band - Devil (Official Music Video)",
              "Ταφ Λάθος - Έχω ( Video art με στίχους)",
              "Ταφ Λάθος - Έχω | Taf Lathos - Eho ( Official Audio )",
              "Ταφ Λάθος - Έχω | Taf Lathos - Eho ( Official Audio )",
              "Fat Freddy's Drop - Blackbird Remix Feat. Kings",
              "Roots Architects 01. 1000 Light Years"
            ]
          },
          "Q3": {
            "id": "PLo5Dkz0iHmDhns-TrCvylpHnvwLeGAmnv",
            "name": "2024 Q3 Playlist",
            "tracks": [
              "Mr Bobby | Manu Chao | Playing For Change",
              "Manu Chao - São Paulo Motoboy (Official Music Video)",
              "King Gizzard & The Lizard Wizard - Honey (Official Video)",
              "Yaeji - Done (Let's Get It) (Official Video)",
              "Aldous Harding - The Barrel (Official Video)",
              "Cool It!",
              "Κοινοί Θνητοί | Ζωή Μεγάλη",
              "Protoje - Switch It Up (Official Video) ft. Original Koffee",
              "1000mods - Overthrown - Official Music Video",
              "Elektro Hafiz - Disko Hafiza ( Live Performance Köln )"
            ]
          },
          "Q4": {
            "id": "PLo5Dkz0iHmDgAmmAc45m-RLVzRK-955aL",
            "name": "2024 Q4 Playlist",
            "tracks": [
              "Tom Misch & Yussef Dayes - Tidal Wave [Official Video]",
              "Fergus Jones ft. Laila Sakini - 'Can't Touch'",
              "Chronixx - \"Skankin' Sweet\" [Official Video] | Chronology",
              "SPRINTS - HEAVY (OFFICIAL VIDEO)",
              "SPRINTS - SHADOW OF A DOUBT (OFFICIAL VIDEO)",
              "Heart Attack",
              "American Speedhead",
              "King Ben - Austuminzi",
              "Back Bitter / SAMI-T From Mighty Crown",
              "Skrillex & Damian \"Jr. Gong\" Marley - Make It Bun Dem [OFFICIAL VIDEO]",
              "The Limiñanas - Prisoner of Beauty (feat. Bobby Gillespie) (Official Video)",
              "Eléwa - Sayin Nothin",
              "Elvis Crespo - Suavemente"
            ]
          }
        },
        "2023": {
          "Q1": {
            "id": "PLo5Dkz0iHmDiCw7fQ3vY3V5Sb7Z26VlQO",
            "name": "2023 Q1 Playlist",
            "tracks": [
              "Kowloon - Wake Up",
              "Everything But The Girl - Nothing Left To Lose",
              "Lidj Incorporated - General Penitentiary",
              "Vasilis Kostas - To Horio (The Village)",
              "Cable Ties - Say What You Mean",
              "Sleaford Mods - UK GRIM",
              "Young Fathers - Tell Somebody",
              "Young Fathers - Rice",
              "Jan Van Angelopoulos & Fotis Siotas - Watching it from Distance",
              "Pavlos Pavlidis - I Mairi",
              "Deaf Radio - Arsenal of Hope",
              "Luude & Issey Cross - Oh My",
              "Rival Sons - Bird In The Hand",
              "Fontaines D.C. - 'Cello Song",
              "Slomosa - There is Nothing New Under the Sun",
              "Caldera x Yushh - Süss Choc ‐ Two [Is Greater Than] One LP - [PDCOLLAB001] - 2023",
              "XEHORÍSMATA | Petros Klampanis"
            ]
          }
        }
      },
      "genres": {
        "Reggae": {
          "2025": {
            "id": "PLo5Dkz0iHmDjHA1aTXkq8dXNWi8VYkVUk",
            "name": "2025 Reggae Playlist",
            "tracks": [
              "Protoje - BIG 45 (Official Video)",
              "Yehoud I - Leave Babylon",
              "Mungo's Hi Fi - Rules of the Dance Ft. Charlie P (Kahn Remix)"
            ]
          },
          "2024": {
            "id": "PLo5Dkz0iHmDjwVzHSo_SEjxKdK_X7LLde",
            "name": "2024 Reggae Playlist",
            "tracks": [
              "Prince Fatty - Expansions ft. Shniece McMenamin",
              "Savages Y Suefo - Our World Our Style",
              "Roots Architects 01. 1000 Light Years",
              "Protoje - Switch It Up (Official Video) ft. Original Koffee",
              "Chronixx - \"Skankin' Sweet\" [Official Video] | Chronology",
              "Chronixx - Here Comes Trouble (Official Music Video)",
              "Samory I Ft. Lila Iké - Outside (Official Video)",
              "Samory I - Crown (Lyric Video)",
              "Major Lazer - Blaze Up The Fire (feat. Chronixx) [Official Lyric Video]",
              "Back Bitter / SAMI-T From Mighty Crown",
              "Skrillex & Damian \"Jr. Gong\" Marley - Make It Bun Dem [OFFICIAL VIDEO]",
              "Original Koffee - Raggamuffin"
            ]
          }
        },
        "Dance": {
          "2024": {
            "id": "PLo5Dkz0iHmDiFL0_0Gp3z7_ouuZ7u5cUF",
            "name": "2024 Dance Playlist",
            "tracks": [
              "Abbebe (Sainte Vie Remix)",
              "Parra for Cuva - Mimose (Official Visuals)",
              "Michelle Gurevich - Party Girl (Sainte Vie Remix) [Sainte Vie]",
              "Seba Campos - Los Halcones Remix (feat. Santiago Moraes) (Official Audio)",
              "Yaeji - Done (Let's Get It) (Official Video)",
              "Nicola Conte & Gianluca Petrella - Inner Light (feat. Raashan Ahmad)",
              "King Ben - Austuminzi"
            ]
          }
        }
      }
    };

    // Load playlist data from JSON file
    async function loadPlaylistData() {
      try {
        const response = await fetch('data/playlists.json');
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();

        // Populate global variables
        playlists = data.quarterly;
        genrePlaylists = data.genres;

        // Initialize UI only after data is loaded
        initializeUI();

        // If API became ready while we were fetching data, checking here ensures nothing was missed
        if (isAPIReady && !playerInitialized) {
          console.log('API ready and Data loaded');
        }

      } catch (error) {
        console.warn('Error fetching playlists.json, using fallback data:', error);

        // Use fallback data
        playlists = fallbackData.quarterly;
        genrePlaylists = fallbackData.genres;

        // Initialize UI with fallback data
        initializeUI();

        // Show subtle notification
        const statusEl = document.getElementById('selection-status');
        if (statusEl) {
          // We don't necessarily need to show an error if fallback works, 
          // but maybe beneficial for debugging. 
          // For user experience, silence is golden if it works.
          console.log('Using offline/fallback playlist data');
        }
      }
    }

    // Initialize UI
    function initializeUI() {
      setupYearButtons();
      setupGenreButtons();
    }

    // Setup genre button handlers
    function setupGenreButtons() {
      const genreSelector = document.getElementById('genre-selector');
      genreSelector.innerHTML = ''; // Clear existing

      Object.keys(genrePlaylists).forEach(genre => {
        const btn = document.createElement('button');
        btn.className = 'genre-btn';
        btn.textContent = genre;
        btn.dataset.genre = genre;

        btn.addEventListener('click', function () {
          // Deactivate quarterly selection
          document.querySelectorAll('.year-btn').forEach(b => b.classList.remove('active'));
          document.getElementById('quarter-selector').classList.remove('visible');
          document.getElementById('selection-status').classList.remove('visible');

          // Update active state
          document.querySelectorAll('.genre-btn').forEach(b => b.classList.remove('active'));
          this.classList.add('active');

          // Update current genre
          updateGenreYearButtons(genre);

          // Auto-select first available year for this genre
          const years = Object.keys(genrePlaylists[genre]);
          if (years.length > 0) {
            // Trigger click on first genre year button to load playlist
            // Sort years in descending order (newest first)
            const sortedYears = years.sort((a, b) => b - a);
            // We need to wait for buttons to be created in updateGenreYearButtons
            setTimeout(() => {
              const firstYearBtn = document.querySelector('#genre-year-selector .quarter-btn');
              if (firstYearBtn) {
                firstYearBtn.click();
              }
            }, 0);
          }
        });

        genreSelector.appendChild(btn);
      });
    }

    // Update genre year buttons
    function updateGenreYearButtons(genre) {
      const selector = document.getElementById('genre-year-selector');
      selector.innerHTML = '';
      selector.classList.add('visible');

      const years = genrePlaylists[genre];
      if (!years) return;

      Object.keys(years).forEach((year, index) => {
        const btn = document.createElement('button');
        btn.className = 'quarter-btn';
        btn.textContent = year;
        btn.dataset.year = year;

        btn.addEventListener('click', function () {
          // Deactivate normal quarterly buttons if any remain
          document.querySelectorAll('.quarter-selector:not(#genre-year-selector) .quarter-btn').forEach(b => b.classList.remove('active'));

          const btns = document.querySelectorAll('#genre-year-selector .quarter-btn');
          btns.forEach(b => b.classList.remove('active'));
          this.classList.add('active');

          loadGenrePlaylist(genre, year);
        });

        selector.appendChild(btn);
      });
    }

    function loadGenrePlaylist(genre, year) {
      const playlist = genrePlaylists[genre][year];
      if (!playlist) return;

      // Reset quarterly selection text
      document.getElementById('selected-playlist').textContent = "";

      displayPlaylist(playlist, 'genre-selection-status', 'selected-genre-playlist');
    }

    // Setup year button handlers
    function setupYearButtons() {
      const yearButtons = document.querySelectorAll('.year-btn');
      yearButtons.forEach(btn => {
        btn.addEventListener('click', function () {
          const year = this.dataset.year;

          // Deactivate genre selection
          document.querySelectorAll('.genre-btn').forEach(b => b.classList.remove('active'));
          document.getElementById('genre-year-selector').classList.remove('visible');
          document.getElementById('genre-selection-status').classList.remove('visible');

          // Update active state
          yearButtons.forEach(b => b.classList.remove('active'));
          this.classList.add('active');

          // Update current year
          currentYear = year;

          // Reset player initialization flag for new year
          playerInitialized = false;

          // Show and update quarter buttons
          updateQuarterButtons(year);

          // Auto-select first available quarter
          const quarters = Object.keys(playlists[year]);
          if (quarters.length > 0) {
            currentQuarter = quarters[0];
            // Trigger click on first quarter button to load playlist
            setTimeout(() => {
              const firstQuarterBtn = document.querySelector('#quarter-selector .quarter-btn');
              if (firstQuarterBtn) {
                firstQuarterBtn.click();
              }
            }, 0);
          }
        });
      });
    }

    // Update quarter buttons based on selected year
    function updateQuarterButtons(year) {
      const quarterSelector = document.getElementById('quarter-selector');
      quarterSelector.innerHTML = '';
      quarterSelector.classList.add('visible');

      const quarters = playlists[year];
      if (!quarters) return;

      Object.keys(quarters).forEach((quarter, index) => {
        const btn = document.createElement('button');
        btn.className = 'quarter-btn';
        btn.textContent = quarter;
        btn.dataset.quarter = quarter;

        btn.addEventListener('click', function () {
          const quarterBtns = document.querySelectorAll('.quarter-btn');
          quarterBtns.forEach(b => b.classList.remove('active'));
          this.classList.add('active');

          currentQuarter = quarter;
          loadPlaylist(currentYear, quarter);
        });

        quarterSelector.appendChild(btn);
      });
    }

    // Load a specific playlist (Quarterly)
    function loadPlaylist(year, quarter) {
      const playlist = playlists[year][quarter];
      if (!playlist) return;

      // Reset genre selection text
      document.getElementById('selected-genre-playlist').textContent = "";

      displayPlaylist(playlist, 'selection-status', 'selected-playlist');
    }

    // Shared function to display playlist
    function displayPlaylist(playlist, statusId, titleId) {
      console.log('Loading playlist:', playlist.name);

      // Show the music content section
      const musicContent = document.getElementById('music-content');
      musicContent.classList.add('visible');

      // Show and update selected playlist text
      const selectionStatus = document.getElementById(statusId);
      selectionStatus.classList.add('visible');
      document.getElementById(titleId).textContent = playlist.name;

      // Load tracks
      const tracklistDiv = document.getElementById('tracklist');
      tracklistDiv.innerHTML = '';

      playlist.tracks.forEach((track, index) => {
        const trackItem = document.createElement('div');
        trackItem.className = 'track-item';
        trackItem.dataset.index = index;

        const trackNumber = document.createElement('span');
        trackNumber.className = 'track-number';
        trackNumber.textContent = String(index + 1).padStart(2, '0');

        const trackName = document.createElement('span');
        trackName.className = 'track-name';
        trackName.textContent = track;

        trackItem.appendChild(trackNumber);
        trackItem.appendChild(trackName);
        tracklistDiv.appendChild(trackItem);
      });

      // Reset last playing index when changing playlists
      lastPlayingIndex = -1;

      // Initialize or update the player
      // Always re-initialize to ensure clean state and avoid transition issues
      initializePlayer(playlist.id);
    }

    // Initialize the YouTube player
    function initializePlayer(playlistId) {
      console.log('Initializing player with playlist:', playlistId);

      // Wait for API if not ready
      if (!isAPIReady) {
        console.log('Waiting for YouTube API...');
        setTimeout(() => initializePlayer(playlistId), 200);
        return;
      }

      // Clear existing interval if any
      if (updateInterval) {
        clearInterval(updateInterval);
        updateInterval = null;
      }

      // Destroy existing player if any
      if (player) {
        try {
          // Get the parent before destroying, to know where to put the new one back
          const currentElement = document.getElementById('youtube-player');
          const parent = currentElement ? currentElement.parentNode : document.querySelector('.video-wrapper');

          player.destroy();
          player = null;

          // Re-create the div if it was removed by destroy()
          if (!document.getElementById('youtube-player') && parent) {
            console.log('Re-creating player container');
            const newDiv = document.createElement('div');
            newDiv.id = 'youtube-player';
            parent.appendChild(newDiv);
          }

        } catch (e) {
          console.log('Error destroying player:', e);
        }
      }

      // Ensure container exists (just in case)
      if (!document.getElementById('youtube-player')) {
        const wrapper = document.querySelector('.video-wrapper');
        if (wrapper) {
          const newDiv = document.createElement('div');
          newDiv.id = 'youtube-player';
          wrapper.appendChild(newDiv);
        }
      }

      // Create new player
      player = new YT.Player('youtube-player', {
        height: '315',
        width: '560',
        playerVars: {
          listType: 'playlist',
          list: playlistId,
          enablejsapi: 1
        },
        events: {
          'onReady': onPlayerReady,
          'onStateChange': onPlayerStateChange,
          'onError': onPlayerError
        }
      });

      playerInitialized = true;
    }

    // Setup track click handlers
    function setupTrackClickHandlers() {
      const trackItems = document.querySelectorAll('.track-item');
      trackItems.forEach(trackItem => {
        // Remove old listeners by cloning
        const newTrackItem = trackItem.cloneNode(true);
        trackItem.parentNode.replaceChild(newTrackItem, trackItem);

        newTrackItem.addEventListener('click', function () {
          const trackIndex = parseInt(this.getAttribute('data-index'));
          console.log('Track clicked:', trackIndex);

          // Play the selected track
          if (player && player.playVideoAt) {
            player.playVideoAt(trackIndex);
          }
        });
      });
    }

    // Function to update active track highlight
    function updateActiveTrack() {
      if (!player || !player.getPlaylistIndex) return;

      try {
        const currentIndex = player.getPlaylistIndex();
        const trackItems = document.querySelectorAll('.track-item');

        // Remove active class from all tracks
        trackItems.forEach(item => item.classList.remove('active'));

        // Add active class to currently playing track
        const currentTrack = document.querySelector(`.track-item[data-index="${currentIndex}"]`);
        if (currentTrack) {
          currentTrack.classList.add('active');

          // Only scroll if the track has changed
          if (currentIndex !== lastPlayingIndex) {
            currentTrack.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            lastPlayingIndex = currentIndex;
          }
        }
      } catch (error) {
        // Silently handle errors (player might not be ready)
      }
    }

    // Handle Player Error (e.g. video unavailable)
    function onPlayerError(event) {
      console.log('Player Error:', event.data);
      // 100: Video not found
      // 101, 150: Video owner does not allow embedding
      if (event.data === 100 || event.data === 101 || event.data === 150) {
        console.log('Skipping unavailable video...');
        if (player && player.nextVideo) {
          // Add a small delay to avoid rapid skipping loops
          setTimeout(() => {
            player.nextVideo();
          }, 500);
        }
      }
    }

    // Handle Player Error (e.g. video unavailable)
    function onPlayerError(event) {
      console.log('Player Error:', event.data);
      // 100: Video not found
      // 101, 150: Video owner does not allow embedding
      if (event.data === 100 || event.data === 101 || event.data === 150) {
        console.log('Skipping unavailable video...');
        if (player && player.nextVideo) {
          // Add a small delay to avoid rapid skipping loops
          setTimeout(() => {
            player.nextVideo();
          }, 500);
        }
      }
    }

    function onPlayerReady(event) {
      console.log('Player ready');
      setupTrackClickHandlers();

      // Clear existing interval if any
      if (updateInterval) {
        clearInterval(updateInterval);
      }

      // Start polling for current track (every 500ms)
      updateInterval = setInterval(updateActiveTrack, 500);

      // Initial update
      setTimeout(updateActiveTrack, 500);
    }

    function onPlayerStateChange(event) {
      console.log('Player state changed:', event.data);
      // Update immediately when state changes
      updateActiveTrack();
    }

    // Clean up interval when page unloads
    window.addEventListener('beforeunload', function () {
      if (updateInterval) {
        clearInterval(updateInterval);
      }
    });

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', loadPlaylistData);
  </script>
</body>

</html>