<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Music - RunTheCode.gr</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <style>
    /* Additional styles for playlist selection */
    .year-selector {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
    }

    .year-btn {
      padding: 0.75rem 1.5rem;
      background-color: rgba(56, 189, 248, 0.1);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s ease;
      font-weight: 500;
    }

    .year-btn:hover {
      background-color: rgba(56, 189, 248, 0.2);
      border-color: var(--accent-primary);
    }

    .year-btn.active {
      background-color: var(--accent-primary);
      border-color: var(--accent-primary);
      color: var(--bg-body);
    }

    .quarter-selector {
      display: none;
      gap: 0.75rem;
      margin-top: 1rem;
      flex-wrap: wrap;
    }

    .quarter-selector.visible {
      display: flex;
    }

    .quarter-btn {
      padding: 0.5rem 1rem;
      background-color: var(--bg-body);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 0.9rem;
    }

    .quarter-btn:hover {
      background-color: rgba(56, 189, 248, 0.1);
      border-color: var(--accent-primary);
      color: var(--text-primary);
    }

    .quarter-btn.active {
      background-color: rgba(56, 189, 248, 0.15);
      border-color: var(--accent-primary);
      color: var(--accent-primary);
      font-weight: 600;
    }

    .selection-status {
      margin-top: 1.5rem;
      display: none;
    }

    .selection-status.visible {
      display: block;
    }

    .music-content {
      display: none;
    }

    .music-content.visible {
      display: block;
    }

    /* Flex container for playlist cards */
    .playlist-info .container {
      display: flex;
      gap: 2rem;
      flex-wrap: wrap;
    }

    .info-card {
      flex: 1;
      min-width: 300px;
    }

    /* Genre specific styles */
    .genre-selector {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
    }

    .genre-btn {
      padding: 0.75rem 1.5rem;
      background-color: rgba(16, 185, 129, 0.1);
      /* Green tint for genre */
      border: 1px solid var(--border-color);
      border-radius: 6px;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s ease;
      font-weight: 500;
    }

    .genre-btn:hover {
      background-color: rgba(16, 185, 129, 0.2);
      border-color: #10b981;
    }

    .genre-btn.active {
      background-color: #10b981;
      border-color: #10b981;
      color: var(--bg-body);
    }
  </style>
</head>

<body>
  <div class="christmas-banner">ðŸŽ„ Merry Christmas & Happy New Year! ðŸŽ…</div>
  <header class="site-header">
    <div class="container">
      <a href="index.html" class="site-title">RunTheCode.gr</a>
      <nav class="breadcrumb">
        <a href="index.html">Home</a>
        <span class="separator">/</span>
        <span class="current">Music</span>
      </nav>
    </div>
  </header>

  <main>
    <section class="music-hero">
      <div class="container">
        <h1>Music</h1>
        <p class="music-subtitle">Curated quarterly playlists featuring handpicked tracks</p>
      </div>
    </section>

    <section class="playlist-info">
      <div class="container">
        <!-- Card 1: Quarterly Collections -->
        <div class="info-card">
          <h2>Quarterly Music Collections</h2>
          <p>Every three months, I curate a special playlist of songs that resonated with me during that period.
            Each collection represents a musical journey through the quarter.</p>

          <p style="margin-top: 1.5rem; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-primary);">Select a
            year:</p>

          <!-- Year Selection -->
          <div class="year-selector">
            <button class="year-btn" data-year="2025">2025</button>
            <button class="year-btn" data-year="2024">2024</button>
            <button class="year-btn" data-year="2023">2023</button>
            <button class="year-btn" data-year="2022">2022</button>
          </div>

          <!-- Quarter Selection (dynamically populated) -->
          <div id="quarter-selector" class="quarter-selector"></div>

          <p id="selection-status" class="current-playlist selection-status">
            Currently selected: <strong><span id="selected-playlist"></span></strong>
          </p>
        </div>

        <!-- Card 2: Genre Based Playlists -->
        <div class="info-card">
          <h2>Genre Based Playlists</h2>
          <p>Exploring specific sounds and vibes. These collections focus on deep dives into specific genres, bringing
            together tracks that define a mood.</p>

          <p style="margin-top: 1.5rem; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-primary);">Select a
            genre:</p>

          <!-- Genre Selection -->
          <div id="genre-selector" class="genre-selector">
            <!-- Dynamically populated -->
          </div>

          <!-- Genre Year Selection (dynamically populated) -->
          <div id="genre-year-selector" class="quarter-selector"></div>

          <p id="genre-selection-status" class="current-playlist selection-status">
            Currently selected: <strong><span id="selected-genre-playlist"></span></strong>
          </p>
        </div>
      </div>
    </section>

    <section id="music-content" class="music-content">
      <div class="container">
        <div class="playlist-grid">
          <div class="video-container">
            <div class="video-wrapper">
              <div id="youtube-player"></div>
            </div>
          </div>

          <div class="tracklist-container">
            <h3>Tracklist</h3>
            <div id="tracklist" class="tracklist">
              <!-- Tracks will be dynamically loaded -->
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer class="site-footer">
    <div class="container">
      <p>&copy; 2025 RunTheCode.gr Team ðŸŽ„</p>
    </div>
  </footer>

  <script>
    // Playlist data structure (populated from JSON)
    let playlists = {};
    let genrePlaylists = {};

    // Player state variables
    let player;
    let isAPIReady = false;
    let playerInitialized = false;
    let updateInterval;
    let currentYear;
    let currentQuarter;
    let lastPlayingIndex = -1;

    // Load YouTube IFrame API
    const tag = document.createElement('script');
    tag.src = 'https://www.youtube.com/iframe_api';
    const firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

    // Called when API is ready (global callback required by YouTube API)
    function onYouTubeIframeAPIReady() {
      isAPIReady = true;
      console.log('YouTube API ready');
    }

    // Fallback data (mirrors playlists.json)
    // Fallback data removed to ensure single source of truth (data/playlists.json)

    // Load playlist data from JSON file
    async function loadPlaylistData() {
      try {
        const response = await fetch('data/playlists.json?v=' + new Date().getTime());
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();

        // Populate global variables
        playlists = data.quarterly;
        genrePlaylists = data.genres;

        // Initialize UI only after data is loaded
        initializeUI();

        // If API became ready while we were fetching data, checking here ensures nothing was missed
        if (isAPIReady && !playerInitialized) {
          console.log('API ready and Data loaded');
        }

      } catch (error) {
        console.error('Error fetching playlists.json:', error);

        // Show error to user
        const quarterlyCard = document.querySelector('.info-card');
        const genreCard = document.querySelectorAll('.info-card')[1];

        if (quarterlyCard) {
          quarterlyCard.innerHTML = `
                <h2>Quarterly Music Collections</h2>
                <div style="padding: 1rem; background-color: rgba(239, 68, 68, 0.1); border: 1px solid var(--accent-secondary); border-radius: 6px; color: var(--accent-secondary);">
                    <p style="font-weight: 600; margin-bottom: 0.5rem;">Unable to load playlists</p>
                    <p style="font-size: 0.9rem;">Please ensure you are viewing this page via a web server (http://) and not directly from the file system (file://).</p>
                </div>
            `;
        }
      }
    }

    // Initialize UI
    function initializeUI() {
      setupYearButtons();
      setupGenreButtons();
    }

    // Setup genre button handlers
    function setupGenreButtons() {
      const genreSelector = document.getElementById('genre-selector');
      genreSelector.innerHTML = ''; // Clear existing

      Object.keys(genrePlaylists).forEach(genre => {
        const btn = document.createElement('button');
        btn.className = 'genre-btn';
        btn.textContent = genre;
        btn.dataset.genre = genre;

        btn.addEventListener('click', function () {
          // Deactivate quarterly selection
          document.querySelectorAll('.year-btn').forEach(b => b.classList.remove('active'));
          document.getElementById('quarter-selector').classList.remove('visible');
          document.getElementById('selection-status').classList.remove('visible');

          // Update active state
          document.querySelectorAll('.genre-btn').forEach(b => b.classList.remove('active'));
          this.classList.add('active');

          // Update current genre
          updateGenreYearButtons(genre);

          // Auto-select first available year for this genre
          const years = Object.keys(genrePlaylists[genre]);
          if (years.length > 0) {
            // Trigger click on first genre year button to load playlist
            // Sort years in descending order (newest first)
            const sortedYears = years.sort((a, b) => b - a);
            // We need to wait for buttons to be created in updateGenreYearButtons
            setTimeout(() => {
              const firstYearBtn = document.querySelector('#genre-year-selector .quarter-btn');
              if (firstYearBtn) {
                firstYearBtn.click();
              }
            }, 0);
          }
        });

        genreSelector.appendChild(btn);
      });
    }

    // Update genre year buttons
    function updateGenreYearButtons(genre) {
      const selector = document.getElementById('genre-year-selector');
      selector.innerHTML = '';
      selector.classList.add('visible');

      const years = genrePlaylists[genre];
      if (!years) return;

      Object.keys(years).forEach((year, index) => {
        const btn = document.createElement('button');
        btn.className = 'quarter-btn';
        btn.textContent = year;
        btn.dataset.year = year;

        btn.addEventListener('click', function () {
          // Deactivate normal quarterly buttons if any remain
          document.querySelectorAll('.quarter-selector:not(#genre-year-selector) .quarter-btn').forEach(b => b.classList.remove('active'));

          const btns = document.querySelectorAll('#genre-year-selector .quarter-btn');
          btns.forEach(b => b.classList.remove('active'));
          this.classList.add('active');

          loadGenrePlaylist(genre, year);
        });

        selector.appendChild(btn);
      });
    }

    function loadGenrePlaylist(genre, year) {
      const playlist = genrePlaylists[genre][year];
      if (!playlist) return;

      // Reset quarterly selection text
      document.getElementById('selected-playlist').textContent = "";

      displayPlaylist(playlist, 'genre-selection-status', 'selected-genre-playlist');
    }

    // Setup year button handlers
    function setupYearButtons() {
      const yearButtons = document.querySelectorAll('.year-btn');
      yearButtons.forEach(btn => {
        btn.addEventListener('click', function () {
          const year = this.dataset.year;

          // Deactivate genre selection
          document.querySelectorAll('.genre-btn').forEach(b => b.classList.remove('active'));
          document.getElementById('genre-year-selector').classList.remove('visible');
          document.getElementById('genre-selection-status').classList.remove('visible');

          // Update active state
          yearButtons.forEach(b => b.classList.remove('active'));
          this.classList.add('active');

          // Update current year
          currentYear = year;

          // Reset player initialization flag for new year
          playerInitialized = false;

          // Show and update quarter buttons
          updateQuarterButtons(year);

          // Auto-select first available quarter
          const quarters = Object.keys(playlists[year]);
          if (quarters.length > 0) {
            currentQuarter = quarters[0];
            // Trigger click on first quarter button to load playlist
            setTimeout(() => {
              const firstQuarterBtn = document.querySelector('#quarter-selector .quarter-btn');
              if (firstQuarterBtn) {
                firstQuarterBtn.click();
              }
            }, 0);
          }
        });
      });
    }

    // Update quarter buttons based on selected year
    function updateQuarterButtons(year) {
      const quarterSelector = document.getElementById('quarter-selector');
      quarterSelector.innerHTML = '';
      quarterSelector.classList.add('visible');

      const quarters = playlists[year];
      if (!quarters) return;

      Object.keys(quarters).forEach((quarter, index) => {
        const btn = document.createElement('button');
        btn.className = 'quarter-btn';
        btn.textContent = quarter;
        btn.dataset.quarter = quarter;

        btn.addEventListener('click', function () {
          const quarterBtns = document.querySelectorAll('.quarter-btn');
          quarterBtns.forEach(b => b.classList.remove('active'));
          this.classList.add('active');

          currentQuarter = quarter;
          loadPlaylist(currentYear, quarter);
        });

        quarterSelector.appendChild(btn);
      });
    }

    // Load a specific playlist (Quarterly)
    function loadPlaylist(year, quarter) {
      const playlist = playlists[year][quarter];
      if (!playlist) return;

      // Reset genre selection text
      document.getElementById('selected-genre-playlist').textContent = "";

      displayPlaylist(playlist, 'selection-status', 'selected-playlist');
    }

    // Shared function to display playlist
    function displayPlaylist(playlist, statusId, titleId) {
      console.log('Loading playlist:', playlist.name);

      // Show the music content section
      const musicContent = document.getElementById('music-content');
      musicContent.classList.add('visible');

      // Show and update selected playlist text
      const selectionStatus = document.getElementById(statusId);
      selectionStatus.classList.add('visible');
      document.getElementById(titleId).textContent = playlist.name;

      // Load tracks
      const tracklistDiv = document.getElementById('tracklist');
      tracklistDiv.innerHTML = '';

      playlist.tracks.forEach((track, index) => {
        const trackItem = document.createElement('div');
        trackItem.className = 'track-item';
        trackItem.dataset.index = index;

        const trackNumber = document.createElement('span');
        trackNumber.className = 'track-number';
        trackNumber.textContent = String(index + 1).padStart(2, '0');

        const trackName = document.createElement('span');
        trackName.className = 'track-name';
        trackName.textContent = track;

        trackItem.appendChild(trackNumber);
        trackItem.appendChild(trackName);
        tracklistDiv.appendChild(trackItem);
      });

      // Reset last playing index when changing playlists
      lastPlayingIndex = -1;

      // Initialize or update the player
      // Always re-initialize to ensure clean state and avoid transition issues
      initializePlayer(playlist.id);
    }

    // Initialize the YouTube player
    function initializePlayer(playlistId) {
      console.log('Initializing player with playlist:', playlistId);

      // Wait for API if not ready
      if (!isAPIReady) {
        console.log('Waiting for YouTube API...');
        setTimeout(() => initializePlayer(playlistId), 200);
        return;
      }

      // Clear existing interval if any
      if (updateInterval) {
        clearInterval(updateInterval);
        updateInterval = null;
      }

      // Destroy existing player if any
      if (player) {
        try {
          // Get the parent before destroying, to know where to put the new one back
          const currentElement = document.getElementById('youtube-player');
          const parent = currentElement ? currentElement.parentNode : document.querySelector('.video-wrapper');

          player.destroy();
          player = null;

          // Re-create the div if it was removed by destroy()
          if (!document.getElementById('youtube-player') && parent) {
            console.log('Re-creating player container');
            const newDiv = document.createElement('div');
            newDiv.id = 'youtube-player';
            parent.appendChild(newDiv);
          }

        } catch (e) {
          console.log('Error destroying player:', e);
        }
      }

      // Ensure container exists (just in case)
      if (!document.getElementById('youtube-player')) {
        const wrapper = document.querySelector('.video-wrapper');
        if (wrapper) {
          const newDiv = document.createElement('div');
          newDiv.id = 'youtube-player';
          wrapper.appendChild(newDiv);
        }
      }

      // Create new player
      player = new YT.Player('youtube-player', {
        height: '315',
        width: '560',
        playerVars: {
          listType: 'playlist',
          list: playlistId,
          enablejsapi: 1
        },
        events: {
          'onReady': onPlayerReady,
          'onStateChange': onPlayerStateChange,
          'onError': onPlayerError
        }
      });

      playerInitialized = true;
    }

    // Setup track click handlers
    function setupTrackClickHandlers() {
      const trackItems = document.querySelectorAll('.track-item');
      trackItems.forEach(trackItem => {
        // Remove old listeners by cloning
        const newTrackItem = trackItem.cloneNode(true);
        trackItem.parentNode.replaceChild(newTrackItem, trackItem);

        newTrackItem.addEventListener('click', function () {
          const trackIndex = parseInt(this.getAttribute('data-index'));
          console.log('Track clicked:', trackIndex);

          // Play the selected track
          if (player && player.playVideoAt) {
            player.playVideoAt(trackIndex);
          }
        });
      });
    }

    // Function to update active track highlight
    function updateActiveTrack() {
      if (!player || !player.getPlaylistIndex) return;

      try {
        const currentIndex = player.getPlaylistIndex();
        const trackItems = document.querySelectorAll('.track-item');

        // Remove active class from all tracks
        trackItems.forEach(item => item.classList.remove('active'));

        // Add active class to currently playing track
        const currentTrack = document.querySelector(`.track-item[data-index="${currentIndex}"]`);
        if (currentTrack) {
          currentTrack.classList.add('active');

          // Only scroll if the track has changed
          if (currentIndex !== lastPlayingIndex) {
            currentTrack.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            lastPlayingIndex = currentIndex;
          }
        }
      } catch (error) {
        // Silently handle errors (player might not be ready)
      }
    }



    // Handle Player Error (e.g. video unavailable)
    function onPlayerError(event) {
      console.log('Player Error:', event.data);
      // 100: Video not found
      // 101, 150: Video owner does not allow embedding
      if (event.data === 100 || event.data === 101 || event.data === 150) {
        console.log('Skipping unavailable video...');
        if (player && player.nextVideo) {
          // Add a small delay to avoid rapid skipping loops
          setTimeout(() => {
            player.nextVideo();
          }, 500);
        }
      }
    }

    function onPlayerReady(event) {
      console.log('Player ready');
      setupTrackClickHandlers();

      // Clear existing interval if any
      if (updateInterval) {
        clearInterval(updateInterval);
      }

      // Start polling for current track (every 500ms)
      updateInterval = setInterval(updateActiveTrack, 500);

      // Initial update
      setTimeout(updateActiveTrack, 500);
    }

    function onPlayerStateChange(event) {
      console.log('Player state changed:', event.data);
      // Update immediately when state changes
      updateActiveTrack();
    }

    // Clean up interval when page unloads
    window.addEventListener('beforeunload', function () {
      if (updateInterval) {
        clearInterval(updateInterval);
      }
    });

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', loadPlaylistData);
  </script>
</body>

</html>